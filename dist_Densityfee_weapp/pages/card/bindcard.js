"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,a)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(a):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../config/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var $timer=0,Bindcard=(_temp2=_class=function(e){function s(){var e,t,n;_classCallCheck(this,s);for(var a=arguments.length,i=Array(a),o=0;o<a;o++)i[o]=arguments[o];return(t=n=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(i)))).$usedState=["cards","orderid","isCard","step1","step2","step3","step","cardid","timerShow","bindSuccess","unbingImg","info","step1Img","step2Img","step3Img","mhhImg","stepcard","screencard","successcard","carImg","countDownNum"],n.config={navigationBarTitleText:"绑卡"},n.$$refs=[],_possibleConstructorReturn(n,t)}return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.state={orderid:"",isCard:!1,step1:!0,step2:!1,step3:!1,step:!1,cardid:"",timerShow:!1,bindSuccess:!1,cards:[],unbingImg:_index3.PATH+"/mImages/unbingcard.png",info:_index3.PATH+"/mImages/infoNew.png",step1Img:_index3.PATH+"/mImages/step1.png",step2Img:_index3.PATH+"/mImages/step2.png",step3Img:_index3.PATH+"/mImages/step3.png",mhhImg:_index3.PATH+"/mImages/xydImg.png",stepcard:_index3.PATH+"/mImages/stepcard.png",screencard:_index3.PATH+"/mImages/screen1.png",successcard:_index3.PATH+"/mImages/success.png",carImg:_index3.PATH+"/mImages/mycard.png",countDownNum:30},this.timer=0,this.requestTimer=0}},{key:"componentWillMount",value:function(){console.log(this.$router.params),this.cardlist()}},{key:"componentDidMount",value:function(){}},{key:"componentDidShow",value:function(){}},{key:"componentDidHide",value:function(){var e=this;0!=e.requestTimer&&clearInterval(e.requestTimer),0!=e.timer&&clearInterval(e.timer)}},{key:"componentDidCatchError",value:function(){}},{key:"cardlist",value:function(){var t=this;_index2.default.showLoading({title:""}),_index2.default.request({url:_index3.BASE_URL+"card/cards",data:{},header:{"content-type":"application/json",token:_index3.globalData.token},success:function(e){_index2.default.hideLoading(),console.log(e.data),t.setState({cards:e.data.data})},fail:function(e){_index2.default.hideLoading()}})}},{key:"onbindCardFn",value:function(){this.setState({step:!0})}},{key:"addbind",value:function(){console.log("开始扫码"),this.setState({step:!0,step1:!0})}},{key:"onscan",value:function(){var n=this;_index2.default.scanCode({}).then(function(e){var t=e.result;console.log("qrurl:"+t),n.requestOpen(t)}).catch(function(e){console.log(e)})}},{key:"requestOpen",value:function(e){_index2.default.showLoading({title:""});var t=this;_index2.default.request({url:_index3.BASE_URL+"card/bindmachine",data:{qrurl:e},header:{"content-type":"application/json",token:_index3.globalData.token},method:"POST",success:function(e){_index2.default.hideLoading(),200==e.data.code?(t.setState({step1:!1,step2:!0,cardid:e.data.data,timerShow:!0}),t.countDown()):221==e.data.code?_index2.default.showModal({title:"提示",content:"亲，两个人不能同时绑定亲情卡哦！",showCancel:!1,success:function(e){e.confirm}}):_index2.default.showModal({title:"提示",content:e.data.msg,showCancel:!1,success:function(e){e.confirm}})},fail:function(e){_index2.default.showToast({title:"请求失败",icon:"fail",duration:2e3})}})}},{key:"countDown",value:function(){var t=this,e=t.state.countDownNum;this.timer=setInterval(function(){e--,t.setState({countDownNum:e}),0==e&&(clearInterval(t.timer),t.state.bindSuccess?t.setState({step:!1,step1:!0,step2:!1}):_index2.default.showModal({title:"提示",content:"操作超时，请重试",showCancel:!1,success:function(e){e.confirm&&t.setState({step:!1,step1:!0,step2:!1})}}))},1e3),this.requestTimer=setInterval(function(){t.checkBindStatus()},2e3)}},{key:"checkBindStatus",value:function(){var t=this;_index2.default.request({url:_index3.BASE_URL+"card/bindstatus",data:{cardid:t.state.cardid},header:{"content-type":"application/json",token:_index3.globalData.token},method:"POST",success:function(e){200==e.data.code&&(console.log("到这里200"),1==e.data.data?t.setState({step1:!1,step2:!1}):2==e.data.data?(clearInterval(t.requestTimer),_index2.default.hideLoading(),t.setState({step1:!1,step2:!1,step3:!0,bindSuccess:!0})):3==e.data.data&&(_index2.default.hideLoading(),clearInterval(t.requestTimer),_index2.default.showModal({title:"提示",content:e.data.msg,showCancel:!1,success:function(e){e.confirm&&_index2.default.navigateBack({})}})))},fail:function(e){console.log("到这里fail"),_index2.default.showToast({title:"请求失败",icon:"fail",duration:2e3})}})}},{key:"unbind",value:function(t){_index2.default.showModal({title:"解绑实体卡",content:"确定解绑实体卡",showCancel:!0,cancelText:"取消",confirmText:"确定",success:function(e){e.confirm&&_index2.default.request({method:"POST",url:_index3.BASE_URL+"card/unbind",data:{cardid:t.currentTarget.dataset.cardid},header:{"content-type":"application/json",token:_index3.globalData.token},success:function(e){console.log(e.data),_index2.default.showToast({title:"解绑成功"}),_index2.default.navigateBack({})}})}})}},{key:"detail",value:function(e){var t=e.currentTarget.dataset.cardid;_index2.default.navigateTo({url:"/pages/orders/orderlist/orderlist?cardid="+t})}},{key:"done",value:function(){this.cardlist(),this.setState({step:!1,step1:!0,step2:!1,step3:!1})}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2],this.__state.cards;return Object.assign(this.__state,{}),this.__state}}]),s}(),_class.properties={},_class.$$events=["detail","unbind","addbind","onscan","done","onbindCardFn"],_temp2);exports.default=Bindcard,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Bindcard,!0));